<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dati su Google Sheets - Sicuro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        .chart-container {
            margin-top: 30px;
            height: 400px;
        }
        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }
        .logout-btn {
            float: right;
            background-color: #f44336;
            margin-bottom: 20px;
        }
        .logout-btn:hover {
            background-color: #d32f2f;
        }
        .input-error {
            border: 1px solid #f44336 !important;
        }
        .error-message {
            color: #f44336;
            font-size: 0.85em;
            margin-top: 5px;
        }
        .csrf-token {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Form di Login -->
    <div id="loginForm" class="auth-container container">
        <h1>Accesso Sicuro</h1>
        <div id="loginNotification" class="notification"></div>
        <form id="loginFormElement">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
                <div id="usernameError" class="error-message hidden"></div>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
                <div id="passwordError" class="error-message hidden"></div>
            </div>
            <button type="submit">Accedi</button>
        </form>
    </div>

    <!-- App Principale -->
    <div id="mainApp" class="container hidden">
        <button id="logoutBtn" class="logout-btn">Logout</button>
        <h1>Inserimento Dati Sicuro</h1>
        
        <div id="notification" class="notification"></div>
        
        <form id="dataForm">
            <input type="hidden" id="csrfToken" class="csrf-token">
            
            <div class="form-group">
                <label for="userName">Nome Utente:</label>
                <input type="text" id="userName" name="userName" required maxlength="50">
                <div id="userNameError" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
                <label for="dataType">Tipo di Dato:</label>
                <select id="dataType" name="dataType" required>
                    <option value="">Seleziona...</option>
                    <option value="temperatura">Temperatura</option>
                    <option value="umidita">Umidità</option>
                    <option value="pressione">Pressione</option>
                    <option value="altro">Altro</option>
                </select>
                <div id="dataTypeError" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
                <label for="dataValue">Valore:</label>
                <input type="number" id="dataValue" name="dataValue" step="0.01" required min="-999999" max="999999">
                <div id="dataValueError" class="error-message hidden"></div>
            </div>
            
            <div class="form-group">
                <label for="dataUnit">Unità di Misura:</label>
                <input type="text" id="dataUnit" name="dataUnit" placeholder="es. °C, %, hPa, etc." maxlength="10">
                <div id="dataUnitError" class="error-message hidden"></div>
            </div>
            
            <button type="submit">Invia Dati</button>
        </form>
        
        <h2>Grafici dei Dati</h2>
        <div class="chart-container">
            <canvas id="dataChart"></canvas>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementi DOM
            const loginForm = document.getElementById('loginForm');
            const loginFormElement = document.getElementById('loginFormElement');
            const loginNotification = document.getElementById('loginNotification');
            const mainApp = document.getElementById('mainApp');
            const logoutBtn = document.getElementById('logoutBtn');
            const dataForm = document.getElementById('dataForm');
            const notification = document.getElementById('notification');
            const csrfToken = document.getElementById('csrfToken');
            
            // Verifica se l'utente è già loggato
            const sessionToken = localStorage.getItem('sessionToken');
            if (sessionToken) {
                verifySession(sessionToken);
            }
            
            // Genera un token CSRF
            function generateCSRFToken() {
                return sha256(Math.random().toString(36).substring(2, 15) + 
                             Math.random().toString(36).substring(2, 15) + 
                             Date.now().toString());
            }
            
            // Imposta il token CSRF
            csrfToken.value = generateCSRFToken();
            
            // Gestione del login
            loginFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Reset errori
                resetErrors();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                // Validazione lato client
                let isValid = true;
                
                if (username.length < 3) {
                    showError('usernameError', 'L\'username deve essere di almeno 3 caratteri');
                    isValid = false;
                }
                
                if (password.length < 6) {
                    showError('passwordError', 'La password deve essere di almeno 6 caratteri');
                    isValid = false;
                }
                
                if (!isValid) return;
                
                // Hash della password (non sicuro in produzione, solo per dimostrazione)
                const hashedPassword = sha256(password);
                
                // Invio credenziali al server
                fetch('http://INDIRIZZO_ESP32:PORTA/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken.value
                    },
                    body: JSON.stringify({ 
                        username, 
                        password: hashedPassword,
                        csrfToken: csrfToken.value
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Credenziali non valide');
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.status === 'success') {
                        // Salva il token di sessione
                        localStorage.setItem('sessionToken', result.sessionToken);
                        showMainApp();
                    } else {
                        showLoginNotification(result.message, 'error');
                    }
                })
                .catch(error => {
                    showLoginNotification('Errore durante il login: ' + error.message, 'error');
                });
            });
            
            // Gestione del logout
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('sessionToken');
                showLoginForm();
            });
            
            // Funzione per verificare la sessione
            function verifySession(token) {
                fetch('http://INDIRIZZO_ESP32:PORTA/verify-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Token': token
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showMainApp();
                    } else {
                        localStorage.removeItem('sessionToken');
                    }
                })
                .catch(() => {
                    localStorage.removeItem('sessionToken');
                });
            }
            
            // Funzione per mostrare l'app principale
            function showMainApp() {
                loginForm.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initApp();
            }
            
            // Funzione per mostrare il form di login
            function showLoginForm() {
                loginForm.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
            
            // Funzione per mostrare notifiche di login
            function showLoginNotification(message, type) {
                loginNotification.textContent = message;
                loginNotification.className = 'notification ' + type;
                loginNotification.style.display = 'block';
                
                setTimeout(() => {
                    loginNotification.style.display = 'none';
                }, 5000);
            }
            
            // Inizializzazione dell'app principale
            function initApp() {
                // Inizializzazione del grafico
                const ctx = document.getElementById('dataChart').getContext('2d');
                const dataChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Gestione del form
                dataForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Reset errori
                    resetErrors();
                    
                    // Genera un nuovo token CSRF per ogni richiesta
                    const newCSRFToken = generateCSRFToken();
                    csrfToken.value = newCSRFToken;
                    
                    const formData = new FormData(dataForm);
                    const data = Object.fromEntries(formData);
                    
                    // Validazione lato client
                    let isValid = true;
                    
                    if (data.userName.trim().length < 2) {
                        showError('userNameError', 'Il nome utente deve essere di almeno 2 caratteri');
                        isValid = false;
                    }
                    
                    if (!data.dataType) {
                        showError('dataTypeError', 'Seleziona un tipo di dato');
                        isValid = false;
                    }
                    
                    if (isNaN(parseFloat(data.dataValue))) {
                        showError('dataValueError', 'Il valore deve essere un numero');
                        isValid = false;
                    }
                    
                    if (!isValid) return;
                    
                    // Invio dati al server ESP32 con token di sessione
                    fetch('http://INDIRIZZO_ESP32:PORTA/save-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-Token': localStorage.getItem('sessionToken'),
                            'X-CSRF-Token': newCSRFToken
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (response.status === 401) {
                            // Sessione non valida
                            localStorage.removeItem('sessionToken');
                            showLoginForm();
                            throw new Error('Sessione scaduta. Effettua nuovamente il login.');
                        }
                        if (response.status === 403) {
                            throw new Error('Token CSRF non valido');
                        }
                        return response.json();
                    })
                    .then(result => {
                        showNotification(result.message, 'success');
                        dataForm.reset();
                        updateChart();
                    })
                    .catch(error => {
                        showNotification('Errore durante il salvataggio dei dati: ' + error.message, 'error');
                    });
                });
                
                // Funzione per mostrare notifiche
                function showNotification(message, type) {
                    notification.textContent = message;
                    notification.className = 'notification ' + type;
                    notification.style.display = 'block';
                    
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 5000);
                }
                
                // Funzione per aggiornare il grafico
                function updateChart() {
                    fetch('http://INDIRIZZO_ESP32:PORTA/get-data', {
                        headers: {
                            'X-Session-Token': localStorage.getItem('sessionToken')
                        }
                    })
                    .then(response => {
                        if (response.status === 401) {
                            // Sessione non valida
                            localStorage.removeItem('sessionToken');
                            showLoginForm();
                            throw new Error('Sessione scaduta. Effettua nuovamente il login.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Elaborazione dei dati per il grafico
                        const labels = data.map(item => item.timestamp || item.date);
                        const values = data.map(item => parseFloat(item.value));
                        
                        dataChart.data.labels = labels;
                        dataChart.data.datasets = [{
                            label: 'Dati',
                            data: values,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }];
                        dataChart.update();
                    })
                    .catch(error => {
                        showNotification('Errore durante il caricamento dei dati: ' + error.message, 'error');
                    });
                }
                
                // Funzione per mostrare errori
                function showError(elementId, message) {
                    const errorElement = document.getElementById(elementId);
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                    
                    const inputElement = errorElement.previousElementSibling;
                    inputElement.classList.add('input-error');
                }
                
                // Funzione per resettare gli errori
                function resetErrors() {
                    const errorElements = document.querySelectorAll('.error-message');
                    errorElements.forEach(element => {
                        element.classList.add('hidden');
                        element.textContent = '';
                    });
                    
                    const inputElements = document.querySelectorAll('.input-error');
                    inputElements.forEach(element => {
                        element.classList.remove('input-error');
                    });
                }
                
                // Carica i dati iniziali per il grafico
                updateChart();
            }
        });
    </script>
</body>
</html>